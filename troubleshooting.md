# QA插件故障排除指南

## 问题：右键点击"下载并上传图片到数据库"没有反应

### 可能的原因和解决方案

#### 1. 插件未正确安装或加载

**检查步骤：**
- 打开 `chrome://extensions/`
- 确认"QA图片采集插件"已启用
- 查看是否有错误信息显示

**解决方案：**
- 如果插件显示错误，点击"重新加载"按钮
- 如果仍有问题，删除插件后重新安装

#### 2. 权限问题

**检查步骤：**
- 在扩展程序页面点击插件的"详细信息"
- 确认"在所有网站上"权限已启用

**解决方案：**
- 启用"在所有网站上"权限
- 或者在特定网站上启用权限

#### 3. 插件设置未配置

**检查步骤：**
- 点击浏览器工具栏中的插件图标
- 检查是否已填写API基础地址和Token

**解决方案：**
- 填写完整的API配置信息
- 确保API地址格式正确（如：`https://api.example.com`）
- 确保Token格式正确（通常以`Bearer `开头）

#### 4. 网页兼容性问题

**检查步骤：**
- 尝试在不同的网站上测试
- 使用提供的 `test.html` 测试页面

**解决方案：**
- 某些网站可能阻止扩展程序运行
- 尝试在其他网站上测试插件功能

#### 5. 调试和日志检查

**调试步骤：**

1. **打开开发者工具：**
   - 按 `F12` 或右键选择"检查"
   - 切换到 `Console` 标签页

2. **检查插件后台日志：**
   - 打开 `chrome://extensions/`
   - 找到QA插件，点击"检查视图"下的"背景页"
   - 查看Console中的日志信息

3. **预期的日志输出：**
   ```
   QA插件已安装，正在创建右键菜单...
   右键菜单创建成功
   右键菜单被点击: downloadAndUploadImage
   开始处理图片: [图片URL]
   handleImageDownloadAndUpload 函数被调用
   正在获取设置...
   获取到的设置: {apiBase: "...", token: "...", ...}
   ```

4. **常见错误信息：**
   - `创建右键菜单失败` - 权限问题
   - `设置不完整` - 需要配置API信息
   - `下载图片失败` - 网络或图片URL问题
   - `添加图片信息失败` - API接口问题

#### 6. 网络和API问题

**检查步骤：**
- 确认API服务器可访问
- 检查API接口是否正常工作
- 验证Token是否有效

**测试方法：**
```bash
# 测试API接口（使用curl或Postman）
curl -X POST "https://your-api.com/api/image/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "category": "数学",
    "collector_type": "手动采集",
    "question_direction": "计算题"
  }'
```

##### 6.1 图片下载403错误解决方案

**问题描述：**插件显示"下载失败: 403"错误，但浏览器可以正常访问图片链接。

**原因分析：**
- 服务器检测到非浏览器请求并拒绝访问
- 缺少必要的请求头（如User-Agent、Referer等）
- 服务器有防爬虫机制
- CORS（跨域资源共享）限制

**解决方案：**

1. **插件已自动处理：**
   - 插件会自动添加浏览器请求头
   - 尝试多种下载配置
   - 包含备用下载方法
   - **页面注入下载**：在页面环境中使用Canvas获取图片数据

2. **手动解决方法：**
   - 右键点击图片选择"在新标签页中打开图片"
   - 复制新标签页中的图片地址
   - 使用复制的地址进行手动上传

3. **替代方案：**
   - 使用浏览器下载图片到本地
   - 通过其他方式获取图片的直接链接
   - 联系网站管理员获取API访问权限

**常见403错误的网站类型：**
- 图片托管服务（如某些CDN）
- 社交媒体平台
- 有防盗链保护的网站
- 需要登录才能访问的图片

#### 7. 浏览器兼容性

**支持的浏览器：**
- Chrome 88+
- Microsoft Edge 88+
- 其他基于Chromium的浏览器

**不支持：**
- Firefox
- Safari
- Internet Explorer

### 完整的故障排除流程

1. **基础检查：**
   - [ ] 插件已安装并启用
   - [ ] 权限已正确配置
   - [ ] API设置已填写

2. **功能测试：**
   - [ ] 使用 `test.html` 页面测试
   - [ ] 在不同网站上测试
   - [ ] 检查右键菜单是否出现

3. **日志分析：**
   - [ ] 检查插件后台日志
   - [ ] 检查网页Console日志
   - [ ] 查看网络请求状态

4. **API验证：**
   - [ ] 测试API接口可访问性
   - [ ] 验证Token有效性
   - [ ] 检查CORS设置

### 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. Chrome浏览器版本
2. 插件版本
3. 错误发生的网站URL
4. 开发者工具中的完整错误日志
5. API配置信息（隐藏敏感信息）

### 常用调试命令

在浏览器Console中运行以下命令进行调试：

```javascript
// 检查插件是否加载
chrome.runtime.getManifest()

// 检查存储的设置
chrome.storage.sync.get(null, console.log)

// 手动触发通知测试
chrome.notifications.create({
  type: 'basic',
  iconUrl: 'icon48.svg',
  title: '测试',
  message: '这是一个测试通知'
})
```